# Кэширование
## Схема работы для постов
Для создания постов ленты я решил использовать внешнюю систему кэширования - Redis. Я использовал ключ по типу `post:{{ postId }}`, само значение было сериализовано в JSON.

На уровне кода для этого добавил новый репозиторий и добавил его использование в главном Usecase'е:
1. на `CreatePost` при удачной записи в базу дополнительно происходит запись в кэш.
2. на `UpdatePost` при удачной правке в базу происходит перезапись поста в кэше.
3. на `DeletePost` при удачном удалении из базы происходит удаление из кэша
4. на `GetPost` происходит сначала проверка поста в кэше, если нет, то происходит поиск в базе, и если запись есть, то происходит запись в кэш.
5. на `AcceptFriendship` происходит перестроение ленты, т.к. добавляется новый друг.

## Схема работы для ленты постов
Для ленты постов решил создать следующую архитектуру:
- На стороне Redis использовал для хранения персональных лент ключи вида `friend:feed:{{ userId }}` с типом LinkedList.
- Отдельный Usecase, который отдаёт два канала:
  1. вида `chan<- *domain.Post` только на запись, из которого берёт в бесконечном цикле id автора, по нему находит всех его друзей и добавляет в Redis'овые LinkedList'ы id поста. После чего оставляет только 1000 самых последних (`LTRIM`)
  2. вида `chan<- int` только на запись, из которого берёт в бесконечном цикле id пользователя для которого нужно полностью перестроить ленту (см п.5 из предыдущего раздела)
- Отдельный админский эндпоинт `/api/admin/rebuild_feeds` который принудительно для всех пользователей пересобирает ленты.

Примерная схема:
![Схема запроса](schemes/cachemanager.svg)

## Запуск проекта
```bash
cd deploy/
docker-compose build
docker-compose up -d
```

## Тестирование запросов
Ссылка на [Postman](../api/HLA.postman_collection.json).
Перед началом тестирования:
1. Необходимо создать пользователя через `Registrate`
2. Выполнить `Login` для того, чтобы проходили другие запросы

Для выполнения перестроения лент:
- Использовать в `Postman` запрос из директории `Admin`, используя значения:
```
adminUsername: admin
adminPassword: adminPassword
```
